<!-- app/templates/dashboard.html -->

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>GitLab æäº¤ç»Ÿè®¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .btn-group .btn {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }

        .table th, .table td {
            vertical-align: middle;
        }

        .text-success {
            color: #0d6efd !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }
    </style>
</head>
<body class="bg-light">

<div class="container my-4">
    <h1 class="mb-4">GitLab æäº¤ç»Ÿè®¡ ğŸ“Š</h1>

    <!-- ç­›é€‰åŒº -->
    <div class="card p-3 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="btn-group mb-2">
                    {% set current_days = request.query_params.get('days') %}
                    {% for d in [1, 7, 14, 30, 60, 180] %}
                    <a href="?days={{ d }}"
                       class="btn btn-sm {% if current_days == d %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        æœ€è¿‘{{ d }}å¤©
                    </a>
                    {% endfor %}
                </div>

                <div class="input-group mb-2" style="width: 350px;">
                    <input type="date" id="start_date" class="form-control form-control-sm"
                           value="{{ request.query_params.get('start_date', '') }}">
                    <span class="input-group-text">è‡³</span>
                    <input type="date" id="end_date" class="form-control form-control-sm"
                           value="{{ request.query_params.get('end_date', '') }}">
                    <button class="btn btn-sm btn-outline-secondary" onclick="applyCustomRange()">
                        ç­›é€‰
                    </button>
                </div>
            </div>


            <!-- æœç´¢è¾“å…¥æ¡† -->
            <div class="col-md-4 d-flex align-items-center" style="gap: 0.5rem;">
                <form class="d-flex align-items-center w-100" method="get" style="flex-wrap: nowrap;">
                    <!-- ä¿ç•™å½“å‰ç­›é€‰æ¡ä»¶ -->
                    {% if request.query_params.get('days') %}
                    <input type="hidden" name="days" value="{{ request.query_params.get('days') }}">
                    {% elif request.query_params.get('start_date') %}
                    <input type="hidden" name="start_date" value="{{ request.query_params.get('start_date') }}">
                    <input type="hidden" name="end_date" value="{{ request.query_params.get('end_date') }}">
                    {% endif %}

                    <!-- æœç´¢è¾“å…¥æ¡†ï¼ˆç¼©å°å®½åº¦ï¼‰ -->
                    <input
                            type="text"
                            name="search"
                            class="form-control form-control-sm"
                            placeholder="æœç´¢å¼€å‘è€…"
                            value="{{ search }}"
                            style="min-width: 120px; width: 160px;"
                    />

                    <!-- æœç´¢æŒ‰é’® -->
                    <button type="submit" class="btn btn-sm btn-primary">
                        ğŸ”
                    </button>

                    <!-- å¯¼å‡º CSV æŒ‰é’® -->
                    <a href="/export?{{ request.query_params | update_query() }}"
                       class="btn btn-sm btn-outline-primary"
                       target="_blank" style="white-space: nowrap;">
                        ğŸ“¥ å¯¼å‡º CSV
                    </a>
                </form>
            </div>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œè¡¨æ ¼ -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th>æ’å</th>
                    <th>å§“å</th>
                    <th>éƒ¨é—¨</th>
                    <th>æ–°å¢è¡Œæ•°</th>
                    <th>åˆ é™¤è¡Œæ•°</th>
                    <th>å‡€å¢è¡Œæ•°</th>
                </tr>
                </thead>
                <tbody>
                {% for item in data %}
                <tr>
                    <td>{{ (page-1)*page_size+loop.index }}</td>
                    <!-- ç‚¹å‡»author_nameå°±è·³è½¬åˆ°è¯¦æƒ…è¶‹åŠ¿å›¾é¡µé¢ -->
                    <td>
                        <a href="/detail?author={{ item.author_name }}"
                           class="text-decoration-none fw-medium"
                           style="position: relative; z-index: 10; font-weight: 500; color: #495057;"
                           onclick="event.stopPropagation()"
                           title="æŸ¥çœ‹ {{ item.author_name }} çš„æäº¤ç‚¹çº¿å›¾">
                            {{ item.author_name }}
                        </a>
                    </td>
                    <td>{{ item.department }}</td>
                    <td>{{ "{:,}".format(item.additions) }}</td>
                    <td>{{ "{:,}".format(item.deletions) }}</td>
                    <td class="{{ 'text-success' if item.net_lines >= 0 else 'text-danger' }}">
                        {{ '+' ~ item.net_lines if item.net_lines >= 0 else item.net_lines }}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="card-footer d-flex flex-wrap justify-content-between align-items-center">
            <small class="mb-2 mb-md-0">å…± {{ total }} ä½å¼€å‘è€…</small>

            <!-- å½“å‰é¡µç ä¿¡æ¯ -->
            <div class="text-center mb-2 mb-md-0">
                <small>
                    ç¬¬ <strong>{{ page }}</strong> é¡µ / å…± <strong>{{ max_page }}</strong> é¡µ
                </small>
            </div>


            <!-- åˆ†é¡µæŒ‰é’®ä¸è·³è½¬ -->
            <div class="d-flex align-items-center">

                <!-- åˆ†é¡µæŒ‰é’®ï¼šé¦–é¡µã€ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µã€æœ«é¡µ -->
                <nav class="me-3">
                    <ul class="pagination pagination-sm mb-0">
                        <!-- ç¬¬ä¸€é¡µ -->
                        <li class="page-item {% if page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="?{{ request.query_params | update_query(page=1) }}"
                               aria-label="First">
                                Â«Â«
                            </a>
                        </li>

                        <!-- ä¸Šä¸€é¡µ -->
                        <li class="page-item {% if page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="?{{ request.query_params | update_query(page=page-1) }}"
                               aria-label="Previous">
                                Â«
                            </a>
                        </li>

                        <!-- ä¸‹ä¸€é¡µ -->
                        <li class="page-item {% if page >= max_page %}disabled{% endif %}">
                            <a class="page-link" href="?{{ request.query_params | update_query(page=page+1) }}"
                               aria-label="Next">
                                Â»
                            </a>
                        </li>

                        <!-- æœ€åä¸€é¡µ -->
                        <li class="page-item {% if page >= max_page %}disabled{% endif %}">
                            <a class="page-link" href="?{{ request.query_params | update_query(page=max_page) }}"
                               aria-label="Last">
                                Â»Â»
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- é¡µç è·³è½¬è¾“å…¥æ¡† + æŒ‰é’® -->
                <div class="input-group" style="width: 100px;">
                    <input
                            type="number"
                            id="gotoPage"
                            class="form-control form-control-sm"
                            placeholder="é¡µç "
                            min="1"
                            max="{{ max_page }}"
                            value="{{ page }}"
                    />
                    <button class="btn btn-sm btn-outline-secondary" onclick="gotoPage()">
                        è·³è½¬
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    function applyCustomRange() {
        const start = document.getElementById('start_date').value;
        const end = document.getElementById('end_date').value;
        if (start && end) {
            const params = new URLSearchParams(window.location.search);
            params.delete('days');
            params.set('start_date', start);
            params.set('end_date', end);
            params.set('page', 1);
            window.location.href = '?' + params.toString();
        }
    }

    function gotoPage() {
        const input = document.getElementById('gotoPage');
        const pageNum = parseInt(input.value);
        const MAX_PAGE = {{ max_page }};

        if (!pageNum || pageNum < 1) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ï¼');
            input.value = 1;
            return;
        }

        if (pageNum > MAX_PAGE) {
            alert('è¶…å‡ºæœ€å¤§é¡µç ï¼');
            input.value = MAX_PAGE;
            return;
        }

        // ä¿ç•™æ‰€æœ‰ç°æœ‰å‚æ•°ï¼Œåªæ›´æ–° page
        const params = new URLSearchParams(window.location.search);
        params.set('page', pageNum);
        window.location.href = '?' + params.toString();
    }


</script>

</body>
</html>